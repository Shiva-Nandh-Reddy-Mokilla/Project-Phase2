name: Build and Deploy Consumer to AKS

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/Consumer/**'
      - 'k8s/**'
      - '.github/workflows/deploy-consumer.yml'
  workflow_dispatch:

env:
  ACR_NAME: shivaacr123
  IMAGE_NAME: eventhub-consumer
  IMAGE_TAG: v2
  AKS_RESOURCE_GROUP: EventHub-test
  AKS_CLUSTER_NAME: phase1-aks

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Login to ACR
      run: az acr login --name ${{ env.ACR_NAME }}
    
    - name: Build and Push Docker Image
      run: |
        cd src/Consumer
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} -f Dockerfile ..
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
    
    - name: Set AKS Context
      run: |
        az aks get-credentials --resource-group ${{ env.AKS_RESOURCE_GROUP }} --name ${{ env.AKS_CLUSTER_NAME }} --overwrite-existing
    
    - name: Deploy to AKS
      run: |
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/secret.yaml
        kubectl apply -f k8s/deployment.yaml
        kubectl rollout status deployment/eventhub-consumer
    
    - name: Verify Deployment
      run: |
        kubectl get pods
        kubectl get services

